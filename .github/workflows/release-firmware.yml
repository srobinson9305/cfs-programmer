name: Build and Release Firmware

on:
  push:
    tags:
      - 'fw-v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v2

    - name: Install ESP32 core
      run: |
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@2.0.14

    - name: Install required libraries
      run: |
        echo "Installing libraries..."
        arduino-cli lib install "Adafruit PN532"
        arduino-cli lib install "U8g2"
        arduino-cli lib install "Adafruit NeoPixel"
        arduino-cli lib install "AESLib"
        arduino-cli lib install "ArduinoJson"
        
        echo ""
        echo "=== Installed Libraries ==="
        arduino-cli lib list

    - name: Compile firmware with OTA partition scheme
      run: |
        echo "Compiling firmware with Minimal SPIFFS partition for OTA support..."

        arduino-cli compile \
          --fqbn esp32:esp32:esp32s3:FlashSize=16M,PartitionScheme=min_spiffs,PSRAM=opi,DebugLevel=none \
          --output-dir build/ \
          --warnings all \
          --verbose \
          firmware/CFS_Handheld_v1.2_OTA/CFS_Handheld_v1.2_OTA.ino

        echo ""
        echo "=== Compiled Files ==="
        ls -lh build/

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF_NAME#fw-v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Extract firmware version from code
      id: code_version
      run: |
        CODE_VERSION=$(grep -E '#define FIRMWARE_VERSION' firmware/CFS_Handheld_v1.2_OTA/CFS_Handheld_v1.2_OTA.ino | sed 's/.*"\(.*\)".*/\1/')
        echo "CODE_VERSION=$CODE_VERSION" >> $GITHUB_OUTPUT
        echo "Code version: $CODE_VERSION"

    - name: Verify version match
      run: |
        TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
        CODE_VERSION="${{ steps.code_version.outputs.CODE_VERSION }}"

        if [ "$TAG_VERSION" != "$CODE_VERSION" ]; then
          echo "❌ ERROR: Version mismatch!"
          exit 1
        fi

    - name: Verify binary size
      run: |
        SIZE=$(stat -c%s build/CFS_Handheld_v1.2_OTA.ino.bin)
        SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
        MAX_SIZE=1992294

        if [ $SIZE -gt $MAX_SIZE ]; then
          echo "❌ ERROR: Binary too large!"
          exit 1
        fi

    - name: Rename binary with version
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        mv build/CFS_Handheld_v1.2_OTA.ino.bin build/CFS_Programmer_fw_v${VERSION}.bin
        cp build/CFS_Programmer_fw_v${VERSION}.bin build/CFS_Programmer_fw_latest.bin
        cd build
        sha256sum CFS_Programmer_fw_v${VERSION}.bin > CFS_Programmer_fw_v${VERSION}.bin.sha256

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/CFS_Programmer_fw_v${{ steps.get_version.outputs.VERSION }}.bin
          build/CFS_Programmer_fw_latest.bin
          build/CFS_Programmer_fw_v${{ steps.get_version.outputs.VERSION }}.bin.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
